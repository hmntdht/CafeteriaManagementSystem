<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Status - Nast Eat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../static/css/style_login.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
  <div class="form-container text-center">
    <h2>Hello, {{ customer_name }}</h2>

    <p id="status-text" class="mb-3">
      Your active orders are listed below:
    </p>

    <div id="orders-container" class="mt-4 text-start"></div>

    <div id="no-orders-message" style="display: none" class="alert alert-info mt-4">
      You have no active orders right now.
    </div>
  </div>

  <script>
    const qrUrl = "/static/images/QR.jpeg"; // QR code path
    const dashboardUrl = "{{ url_for('dashboard') }}";
    let stopPolling = false;

    function formatPrice(price) {
      return "रु" + price.toFixed(2);
    }

    function buildOrderCard(order) {
      let statusClass = "text-primary";
      if (order.status === "Accepted") statusClass = "text-success";
      else if (order.status === "Rejected") statusClass = "text-danger";

      // Pending → only status + waiting
      if (order.status === "Pending") {
        return `
          <div class="card mb-4">
            <div class="card-body">
              <h4 class="card-title">Order #${order.order_id}</h4>
              <p><small>Ordered at: ${order.order_datetime}</small></p>
              <p><strong>Status:</strong> <span class="${statusClass}">${order.status}</span></p>
              <div class="alert alert-info mt-3">Waiting for confirmation...</div>
            </div>
          </div>
        `;
      }

      // Accepted → full details + QR
      if (order.status === "Accepted") {
        const itemsHtml = order.items.map(item => {
          const discountedTotal = item.discounted_price * item.quantity;
          const originalTotal = item.price * item.quantity;
          const hasDiscount = Math.abs(discountedTotal - originalTotal) > 0.01;

          return `
            <li class="list-group-item d-flex justify-content-between">
              <span>${item.name} × ${item.quantity}</span>
              <span>
                ${hasDiscount 
                  ? `<s>${formatPrice(originalTotal)}</s> <span class="text-success fw-bold">${formatPrice(discountedTotal)}</span>` 
                  : formatPrice(originalTotal)}
              </span>
            </li>
          `;
        }).join("");

        const totalOriginal = order.total_original;
        const totalDiscounted = order.total_discounted;
        const hasTotalDiscount = Math.abs(totalDiscounted - totalOriginal) > 0.01;

        const totalHtml = hasTotalDiscount 
          ? `<s>${formatPrice(totalOriginal)}</s> → <span class="text-success fw-bold">${formatPrice(totalDiscounted)}</span>`
          : formatPrice(totalDiscounted);

        return `
          <div class="card mb-4">
            <div class="card-body">
              <h4 class="card-title">Order #${order.order_id}</h4>
              <p><small>Ordered at: ${order.order_datetime}</small></p>
              <p><strong>Status:</strong> <span class="${statusClass}">${order.status}</span></p>
              <ul class="list-group mb-3">${itemsHtml}</ul>
              <p><strong>Total:</strong> ${totalHtml}</p>
              <h6>You Can Pay at the Counter</h6>
              <h6>Payment QR Code</h6>
              <img src="${qrUrl}" alt="Scan to pay" class="img-fluid border rounded p-2" style="max-width:200px;">
              <div class="mt-3 text-center">
                <a href="${dashboardUrl}" class="btn btn-success">Place New Order</a>
              </div>
            </div>
          </div>
        `;
      }

      // Rejected → rejection alert
      if (order.status === "Rejected") {
        return `
          <div class="card mb-4 border-danger">
            <div class="card-body">
              <h4 class="card-title">Order #${order.order_id}</h4>
              <p><small>Ordered at: ${order.order_datetime}</small></p>
              <p><strong>Status:</strong> <span class="${statusClass}">${order.status}</span></p>
              <div class="alert alert-danger mt-3">
                Sorry, your order was rejected.
              </div>
              <div class="mt-3 text-center">
                <a href="${dashboardUrl}" class="btn btn-danger">Place New Order</a>
              </div>
            </div>
          </div>
        `;
      }
    }

    function checkOrderStatus() {
      if (stopPolling) return;

      $.getJSON("/order_status/{{ session['user_id'] }}", function (data) {
        $("#orders-container").empty();

        if (!data.orders || data.orders.length === 0) {
          $("#no-orders-message").show();
          return;
        }

        $("#no-orders-message").hide();

        data.orders.forEach(order => {
          $("#orders-container").append(buildOrderCard(order));
        });

      }).fail(function() {
        console.error("Failed to fetch order status.");
      });
    }

    // Poll every 3 seconds
    const pollingInterval = setInterval(checkOrderStatus, 3000);
    checkOrderStatus();
  </script>
</body>
</html>
