<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Status - Nast Eat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../static/css/style_login.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
  <div class="form-container text-center">
    <h2>Hello, {{ customer_name }}</h2>

    <p id="status-text" class="mb-3">
      Your order is being processed. Current status:
      <span id="status" class="fw-bold text-primary">Pending</span>
    </p>

      <div id="loading-message" class="mb-3">
      <p>Waiting for confirmation...</p>
    </div>


    <div id="orders-container" class="mt-4 text-start"></div>

    <div id="rejected-message" style="display: none" class="alert alert-danger mt-4">
      Sorry, your order was rejected.
      <div class="mt-3 text-center">
        <a href="{{ url_for('dashboard') }}" class="btn btn-danger">Place New Order</a>
      </div>
    </div>
  </div>

  <script>
    const qrUrl = "/static/images/QR.jpeg"; // QR code path
    const dashboardUrl = "{{ url_for('dashboard') }}";
    let stopPolling = false;
function formatPrice(price) {
  // Round to 2 decimal places and add currency symbol
  return "रु" + price.toFixed(2);
}

function buildOrderCard(order) {
  const itemsHtml = order.items.map(item => {
    const discountedTotal = item.discounted_price * item.quantity;
    const originalTotal = item.price * item.quantity;
    const hasDiscount = Math.abs(discountedTotal - originalTotal) > 0.01;

    return `<li class="list-group-item d-flex justify-content-between">
              <span>${item.name} × ${item.quantity}</span>
              <span>
                ${hasDiscount 
                  ? `<s>${formatPrice(originalTotal)}</s> <span class="text-success fw-bold">${formatPrice(discountedTotal)}</span>` 
                  : formatPrice(originalTotal)}
              </span>
            </li>`;
  }).join("");

  // Calculate totals safely
  const totalOriginal = order.total_original;
  const totalDiscounted = order.total_discounted;
  const hasTotalDiscount = Math.abs(totalDiscounted - totalOriginal) > 0.01;

  const totalHtml = hasTotalDiscount 
    ? `<s>${formatPrice(totalOriginal)}</s> → <span class="text-success fw-bold">${formatPrice(totalDiscounted)}</span>`
    : formatPrice(totalDiscounted);

  return `
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Order #${order.order_id}</h4>
        <p><small>Ordered at: ${order.order_datetime}</small></p>
        <ul class="list-group mb-3">${itemsHtml}</ul>
        <p><strong>Total:</strong> ${totalHtml}</p>
        <h6>You Can Pay at the Counter</h6>
        <h6>Payment QR Code</h6>
        <img src="${qrUrl}" alt="Scan to pay" class="img-fluid border rounded p-2" style="max-width:200px;">
        <div class="mt-3 text-center">
          <a href="${dashboardUrl}" class="btn btn-success">Place New Order</a>
        </div>
      </div>
    </div>
  `;
}

    function updateStatus(order) {
      if (!order) {
        $("#status").text("No active order").removeClass("text-primary text-success text-danger");
        $("#status-text, #loading-spinner, #orders-container, #rejected-message").hide();
        stopPolling = true;
        return;
      }

      const status = order.status;
      $("#status-text").show();

      if (status === "Pending") {
        $("#status").text("Pending").removeClass("text-success text-danger").addClass("text-primary");
        $("#loading-message").show(); 
        $("#orders-container, #rejected-message").hide();
      }
      else if (status === "Accepted") {
        $("#status").text("Accepted").removeClass("text-primary text-danger").addClass("text-success");
        $("#loading-message").hide(); 
        $("#orders-container").html(buildOrderCard(order)).show();
        $("#rejected-message").hide();
      }
      else if (status === "Rejected") {
        $("#status").text("Rejected").removeClass("text-primary text-success").addClass("text-danger");
        $("#loading-spinner, #orders-container").hide();
        $("#rejected-message").show();
        stopPolling = true;
      }
    }

    function checkOrderStatus() {
      if (stopPolling) return;

      $.getJSON("/order_status/{{ session['user_id'] }}", function (data) {
        updateStatus(data.order);
      }).fail(function() {
        console.error("Failed to fetch order status.");
      });
    }

    // Poll every 3 seconds for quicker updates
    const pollingInterval = setInterval(checkOrderStatus, 3000);
    checkOrderStatus();
  </script>
</body>
</html>
